= CVE-2021-34527 分析报告
:imagesdir: Figures
:toc:
:toclevels: 3
:icons: font

2021 年 6 月 29 日，一个非常严重的 Windows 打印服务漏洞作为 0day 被曝光，漏洞基础评分 8.8 分，发布于 GitHub 上（现已删除）。
该漏洞就是著名的 PrintNightmare，危险性甚至高于永恒之蓝。

== 漏洞基本信息

该漏洞几乎作用于 Windows 7、Windows Server 2008 之后的所有版本，详细信息参见<<官方网站>>。

攻击者可通过普通用户权限认证，以管理员权限远程执行任意代码。
就漏洞利用难度来看，该漏洞非常容易利用，因此危害极大。

== 漏洞发现过程

该漏洞基于漏洞 CVE-2021-1675。
1675 漏洞是一个本地提权漏洞，也是基于 Windows 打印机体系之上的一个高危漏洞。

在了解 1675 漏洞之前，应该对 Windows 打印后台处理程序体系架构有个大致的了解。

== Windows 打印后台处理程序体系架构

spooler 体系架构可以用下图来表示：

image::Print Spooler Architecture.png[]

具体来说，后台打印程序用于管理打印任务，它由以下部件组成：

winspool.drv:: 提供给用户的动态链接库文件。
该文件定义了 spooler 相关的 Win32 API 供用户调用。
里面的 API 均采用远程过程调用的形式来获取服务。

spoolsv.exe:: spoolsv.exe 担当体系中服务器的角色，作为第一个处理 API 调用的程序。
如此设计是为了让 print spooler 既能处理本地打印作业，又能无差别处理远程打印作业。

spoolsv.dll:: 路由程序。
它将 spoolsv.exe 接收的打印请求，向各个打印提供程序发起，并决定由哪个打印提供程序最终处理该请求。
它的作用就是区分打印任务是远程任务还是本地任务。
在远程机器上它就会将任务固定分配给本地打印提供程序。

localspl.dll:: 本地打印提供程序。
打印提供程序主要任务是解决打印任务管理的需求，绝大多数的 API 都是在这个模块内实现的。

=== CVE-2021-1675 调用流程

根据上述理论来继续研究，举个例子，当我调用 AddPrinterDriverEx 函数时（CVE-2021-1675），会经过以下流程：

==== 函数版本选择

首先该函数实际上是个宏，会根据本地的编译环境选择 Unicode 版本（W）或 Ansi 版本（A），如图：

image::AddPrinterDriverEx.png[]

但不管是宽字符还是窄字符版本，其实结果都没差，因为 Windows 内核的字符串是使用 Unicode 编码的，所以最终 Ansi 版本的调用都会转换成 Unicode 版本的调用，如图：

image::AnsiToUnicode.png[]

当 Ansi 函数的参数均转换成 Unicode 版本后，就调用了一个函数：

image::AnsiCallUnicode.png[]

而该函数实际上就是 Unicode 版本的 AddPrinterDriverEx：

image::GetUnicodeProcAddress.png[]

==== API 函数发送 RPC 请求到 spooler 服务器上

进入 Unicode 版本的函数内部后，首先会根据 Level 的数值对函数参数类型做一个选择：

image::pDriverInfo.png[]

该漏洞中我们会设置 Level 为 2，也就是选择参数 pDriverInfo 的类型为 DRIVER_INFO_2 结构体。
然后接下来 Windows 就会对函数参数做一个处理，处理完成后会通过远程过程调用继续处理该 API：

image::set arguments.png[]

image::NdrClientCall3.png[]


==== MSRPC 机制

微软的远程过程调用机制基于 DCE 标准进行构建。
通俗来解释，远程过程调用就是在远程系统上运行进程，这些进程都是程序员或者系统预先定义好的。

RPC 的具体做法就是将想要远程调用的函数序列化，通过网络将它传送至远程系统上，远程系统再将之反序列化，并执行之。
在微软构建的体系中，TCP/IP 和 SMB 是通常被选择来传输 RPC 调用的协议。

想要使用 MSRPC，首先得定义调用的函数的 IDL 接口描述，然后使用 MIDL 工具生成客户端和服务端相应的序列化程序 stub。
而对一些 Win32 API 来说，它本身就定义好了服务端 stub，我们就可以只生成并使用客户端 stub 就够了。

MSRPC 使用 UUID 来标识某一类型的协议，如 MS-RPRN 就用来描述远程打印协议，所有跟远程打印相关的函数均属于该协议的一部分，MSPRC 使用 UUID `12345678-1234-ABCD-EF00-0123456789AB` 来标识该协议。

image::spoolss uuid.png[]

接着，可以继续在此连接基础上，使用 operator number 来标识协议内的函数，以此来远程调用，比如 AddPrinterDriverEx 就是使用 89 来标识自己。

image::AddPrinterDriverEx Opnum.png[]

在使用 MSRPC 的过程中，需要注意的是，TCP/IP 连接使用的是动态端口，需要通过监听在 135 端口的 endpoint mapper 来获取到端口值。
另外，一些 RPC 函数需要认证才能调用，因此本漏洞需要一个普通用户权限。

[bibliography]
== 参考文献
- [[[官方网站]]] https://msrc.microsoft.com/update-guide/en-US/vulnerability/CVE-2021-34527